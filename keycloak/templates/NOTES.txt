CHART NAME: {{ .Chart.Name }}
CHART VERSION: {{ .Chart.Version }}
APP VERSION: {{ .Chart.AppVersion }}

** Please be patient while the chart is being deployed **

{{- if include "keycloak.isOptimizedImage" . }}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸš€ BySamio Keycloak OPTIMIZED Image Detected                              â•‘
â•‘                                                                            â•‘
â•‘  Image: {{ include "keycloak.image" . | trunc 60 }}
â•‘                                                                            â•‘
â•‘  This is a pre-built, distroless image optimized for production:           â•‘
â•‘    âœ“ Faster startup (no build phase required)                              â•‘
â•‘    âœ“ Read-only root filesystem (enhanced security)                         â•‘
â•‘    âœ“ Smaller attack surface (distroless base)                              â•‘
â•‘    âœ“ No shell access (security hardened)                                   â•‘
â•‘                                                                            â•‘
â•‘  Note: Configuration changes require a new optimized image build.          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{{- end }}

{{- if .Values.diagnosticMode.enabled }}
The chart has been deployed in diagnostic mode. All probes have been disabled and the command has been overridden.
  kubectl exec -it {{ include "keycloak.fullname" . }}-0 -n {{ include "keycloak.namespace" . }} -- /bin/bash
{{- end }}

Keycloak can be accessed through the following DNS name from within your cluster:

    {{ include "keycloak.fullname" . }}.{{ include "keycloak.namespace" . }}.svc.{{ .Values.clusterDomain }} (port {{ if .Values.tls.enabled }}{{ .Values.service.ports.https }}{{ else }}{{ .Values.service.ports.http }}{{ end }})

To access Keycloak from outside the cluster execute the following commands:

{{- if .Values.ingress.enabled }}

1. Get the Keycloak URL and associate its hostname to your cluster external IP:

   export CLUSTER_IP=$(minikube ip) # On Minikube. Use: `kubectl cluster-info` on others K8s clusters
   echo "Keycloak URL: http{{ if .Values.ingress.tls }}s{{ end }}://{{ .Values.ingress.hostname }}{{ .Values.httpRelativePath }}"
   echo "$CLUSTER_IP  {{ .Values.ingress.hostname }}" | sudo tee -a /etc/hosts

{{- else if contains "NodePort" .Values.service.type }}

1. Get the Keycloak URL by running these commands:

   export HTTP_NODE_PORT=$(kubectl get --namespace {{ include "keycloak.namespace" . }} -o jsonpath="{.spec.ports[?(@.name=='http')].nodePort}" services {{ include "keycloak.fullname" . }})
   export HTTPS_NODE_PORT=$(kubectl get --namespace {{ include "keycloak.namespace" . }} -o jsonpath="{.spec.ports[?(@.name=='https')].nodePort}" services {{ include "keycloak.fullname" . }})
   export NODE_IP=$(kubectl get nodes --namespace {{ include "keycloak.namespace" . }} -o jsonpath="{.items[0].status.addresses[0].address}")

   echo "Keycloak URL: http://${NODE_IP}:${HTTP_NODE_PORT}{{ .Values.httpRelativePath }}"
   echo "Keycloak URL: https://${NODE_IP}:${HTTPS_NODE_PORT}{{ .Values.httpRelativePath }}"

{{- else if contains "LoadBalancer" .Values.service.type }}

1. Get the Keycloak URL by running these commands:

   NOTE: It may take a few minutes for the LoadBalancer IP to be available.
         You can watch its status by running 'kubectl get --namespace {{ include "keycloak.namespace" . }} svc -w {{ include "keycloak.fullname" . }}'

   export HTTP_SERVICE_PORT=$(kubectl get --namespace {{ include "keycloak.namespace" . }} -o jsonpath="{.spec.ports[?(@.name=='http')].port}" services {{ include "keycloak.fullname" . }})
   export HTTPS_SERVICE_PORT=$(kubectl get --namespace {{ include "keycloak.namespace" . }} -o jsonpath="{.spec.ports[?(@.name=='https')].port}" services {{ include "keycloak.fullname" . }})
   export SERVICE_IP=$(kubectl get svc --namespace {{ include "keycloak.namespace" . }} {{ include "keycloak.fullname" . }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

   echo "Keycloak URL: http://${SERVICE_IP}:${HTTP_SERVICE_PORT}{{ .Values.httpRelativePath }}"
   echo "Keycloak URL: https://${SERVICE_IP}:${HTTPS_SERVICE_PORT}{{ .Values.httpRelativePath }}"

{{- else if contains "ClusterIP" .Values.service.type }}

1. Get the Keycloak URL by running these commands:

   echo "Keycloak URL: http://127.0.0.1:8080{{ .Values.httpRelativePath }}"
   kubectl port-forward --namespace {{ include "keycloak.namespace" . }} svc/{{ include "keycloak.fullname" . }} 8080:{{ .Values.service.ports.http }}

{{- end }}

2. Access Keycloak using the admin credentials:

   echo Username: {{ .Values.auth.adminUser }}
   echo Password: $(kubectl get secret --namespace {{ include "keycloak.namespace" . }} {{ include "keycloak.secretName" . }} -o jsonpath="{.data.{{ include "keycloak.secretPasswordKey" . }}}" | base64 -d)

{{- if .Values.metrics.enabled }}

3. Access Keycloak metrics:

   kubectl port-forward --namespace {{ include "keycloak.namespace" . }} svc/{{ printf "%s-metrics" (include "keycloak.fullname" .) }} 9000:{{ .Values.metrics.service.ports.metrics }}
   curl http://127.0.0.1:9000/metrics

{{- end }}

{{- if .Values.postgresql.enabled }}

Note: A PostgreSQL database has been deployed as part of this chart.
To access it:

   kubectl port-forward --namespace {{ include "keycloak.namespace" . }} svc/{{ .Release.Name }}-postgresql 5432:5432
{{- end }}

{{- include "keycloak.validateValues" . }}
