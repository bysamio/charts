{{- if and .Values.containerPorts.http (ne (int .Values.containerPorts.http) 80) }}
{{- /* Create Apache config to use non-privileged ports when containerPorts.http is not 80 */}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-apache-config
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
    {{- if .Values.commonLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 4 }}
    {{- end }}
  {{- if .Values.commonAnnotations }}
  annotations:
    {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
data:
  ports.conf: |
    # Apache ports configuration for non-privileged ports
    Listen {{ .Values.containerPorts.http }}
    {{- if .Values.containerPorts.https }}
    <IfModule ssl_module>
      Listen {{ .Values.containerPorts.https }}
    </IfModule>
    {{- end }}
    <IfModule mod_gnutls.c>
      Listen {{ .Values.containerPorts.https }}
    </IfModule>
  000-default.conf: |
    <VirtualHost *:{{ .Values.containerPorts.http }}>
      ServerAdmin webmaster@localhost
      ServerName localhost
      DocumentRoot /var/www/html

      <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
      </Directory>

      # Enable PHP error logging to stderr (so it appears in container logs)
      php_flag display_errors Off
      php_flag log_errors On
      php_value error_log /proc/self/fd/2
      php_value error_reporting E_ALL

      ErrorLog /proc/self/fd/2
      CustomLog /proc/self/fd/1 combined
      LogLevel error
    </VirtualHost>
  custom-entrypoint.sh: |
    #!/bin/bash

    set -euo pipefail

    APACHE_PORT="${APACHE_PORT:-8080}"

    WWW_DIR="/var/www/html"

    echo "=== WordPress Kubernetes Entrypoint ==="

    echo "Using non-privileged port: ${APACHE_PORT}"

    # If custom apache config is mounted into /etc/apache2, leave it alone.

    # Ensure ServerName exists to suppress the warning (only possible as root).

    if [ "$(id -u)" -eq 0 ]; then

      if [ ! -f /etc/apache2/conf-available/servername.conf ]; then

        echo "ServerName localhost" > /etc/apache2/conf-available/servername.conf

        a2enconf servername >/dev/null 2>&1 || true

      fi

    fi

    # If files were copied by root during image build or an init step, fix ownership

    # only when running as root (avoid failing when container runs as non-root).

    if [ -d "${WWW_DIR}" ] && [ "$(id -u)" -eq 0 ]; then

      echo "Fixing ownership and permissions for ${WWW_DIR} ..."

      chown -R www-data:www-data "${WWW_DIR}" || true

      # Ensure wp-content is writable by www-data

      mkdir -p "${WWW_DIR}/wp-content"

      chmod -R g+rwX "${WWW_DIR}/wp-content" || true

    fi

    # Quick sanity checks (non-fatal): ensure key files or apache configs exist

    if [ ! -f "${WWW_DIR}/index.php" ]; then

      echo "WARNING: ${WWW_DIR}/index.php not found. WordPress files may be missing."

    fi

    if [ ! -f /etc/apache2/ports.conf ]; then

      echo "WARNING: /etc/apache2/ports.conf not found. Make sure your ConfigMap is mounted."

    fi

    echo "Starting official WordPress entrypoint (apache2 in foreground)..."

    # Exec official entrypoint so it becomes PID 1 and receives signals.

    exec /usr/local/bin/docker-entrypoint.sh apache2-foreground
{{- end }}
